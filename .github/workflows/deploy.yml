name: CI/CD Full Process

on:
  push:
    branches: [ "main" ]

jobs:
  # --- JOB 1 & 2: BUILD (GIỮ NGUYÊN KHÔNG ĐỔI) ---
  build-backend:
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/nodejs2api-backend:latest

  build-frontend:
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/nodejs2api-frontend:latest

  # --- JOB 3: DEPLOY (PHẦN ĐÃ SỬA LẠI) ---
  deploy:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Cài Cloudflared để tạo đường hầm
      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      # 2. Cấu hình SSH để đi qua Cloudflared
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Tìm xem cloudflared nằm ở đâu
          CLOUDFLARED_PATH=$(which cloudflared)

          # Tạo file config
          echo "Host vps" >> ~/.ssh/config
          echo "  HostName ${{ secrets.HOST }}" >> ~/.ssh/config
          echo "  User ${{ secrets.USERNAME }}" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          # Quan trọng: Thêm --loglevel error để không bị rác log gây lỗi copy
          echo "  ProxyCommand $CLOUDFLARED_PATH access ssh --hostname %h --loglevel error" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

      # 3. Copy file vào thư mục tàm (/tmp) để tránh lỗi quyền hạn
      - name: Copy Config Files to VPS
        run: |
          # Copy file docker compose vào thư mục tạm /tmp
          scp docker-compose.prod.yml vps:/tmp/docker-compose.yml
          
          # Nén thư mục nginx lại rồi copy cho gọn
          tar -czf nginx.tar.gz nginx/nginx.conf
          scp nginx.tar.gz vps:/tmp/nginx.tar.gz

      # 4. SSH vào để di chuyển file về đúng chỗ và chạy
      - name: Execute Remote SSH Commands
        run: |
          ssh vps << 'EOF'
            # Vào thư mục người dùng (thường là /home/rocky)
            cd $HOME
            
            # Tạo thư mục dự án nếu chưa có
            mkdir -p my-app/nginx
            
            # Di chuyển file từ /tmp về thư mục dự án
            mv /tmp/docker-compose.yml ./my-app/docker-compose.yml
            
            # Giải nén nginx
            tar -xzf /tmp/nginx.tar.gz -C ./my-app
            
            # Vào thư mục dự án
            cd my-app
            
            # Tạo file .env
            echo "${{ secrets.ENV_FILE }}" > .env
            
            # Chạy lệnh Docker
            docker compose pull
            docker compose up -d
            docker image prune -f
          EOF